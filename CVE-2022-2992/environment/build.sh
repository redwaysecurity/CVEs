#!/bin/bash

echo "Configuring gitlab container"
docker pull gitlab/gitlab-ee:15.3.1-ee.0

# Building Continaer
COMPOSE_PROJECT_NAME="gitlab"
docker-compose up -d

# Waiting for container to be healthy before continuing [ Timeout set to 2000 seconds ]
bash healthy.sh gitlab 2000

# $TOKEN=`tr -dc A-Za-z0-9 </dev/urandom | head -c 24 ; echo ''`
echo "Creating personal access token and adding users"
docker exec -e TOKEN=$TOKEN -it gitlab gitlab-rails runner "token = User.find_by_username('root').personal_access_tokens.create(scopes: [:sudo, :api], name: 'Automation token'); token.set_token('w4dg6wVj7j7xlJgpGLEYdwFe'); token.save!"

# Creating user redway with password as SuperStrongestGitlabPassword
curl --request POST --header "PRIVATE-TOKEN: w4dg6wVj7j7xlJgpGLEYdwFe" --data "skip_confirmation=true&email=redway@gitlab.example&name=redway&username=redway&password=SuperStrongestGitlabPassword" "http://gitlab.example:880/api/v4/users"

